<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel Admin | TênisX</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app">
    <!-- HEADER -->
    <header class="header">
      <div class="header-inner">
        <div>
          <div class="logo">
            <div class="logo-icon">TX</div>
            <div class="logo-text">
              <span>TÊNISX</span>
              <span>Console administrativo</span>
            </div>
          </div>
          <div class="search-bar">
            <input type="text" placeholder="Buscar produto, pedido ou vendedor..." />
            <button>Buscar</button>
          </div>
        </div>

        <nav class="nav">
          <a href="index.html">Loja</a>
          <a href="admin.html" class="active">Painel admin</a>
          <span class="role-tag">ADMIN</span>
        </nav>
      </div>
    </header>

    <main class="container">
      <!-- TÍTULO -->
      <section style="margin-bottom: 16px;">
        <h1 class="page-title">Gestão de produtos</h1>
        <p class="page-subtitle">
          Cadastre, atualize e exclua produtos exibidos na loja.
        </p>
      </section>

      <!-- GRID: FORM + LISTA -->
      <section class="grid" style="margin-bottom: 24px;">
        <!-- FORMULÁRIO -->
        <article class="card" style="align-self:flex-start;">
          <h2 class="form-section-title">Adicionar / editar produto</h2>
          <p class="page-subtitle" style="margin-bottom: 10px;">
            Preencha os campos e salve para que o produto apareça na loja.
          </p>

          <form class="form" id="form-produto">
            <div class="form-row">
              <label for="nome">Nome do produto</label>
              <input id="nome" type="text" placeholder="Ex.: NK Dunk Low Panda" required />
            </div>

            <div class="form-row">
              <label for="marca">Marca</label>
              <input id="marca" type="text" placeholder="Ex.: Nike, Adidas, New Balance..." required />
            </div>

            <div class="form-row">
              <label for="genero">Gênero</label>
              <select id="genero">
                <option value="Unissex">Unissex</option>
                <option value="Masculino">Masculino</option>
                <option value="Feminino">Feminino</option>
              </select>
            </div>

            <div class="form-row">
              <label for="categoria">Categoria</label>
              <input id="categoria" type="text" placeholder="Ex.: Casual, Corrida, Skate..." />
            </div>

            <div class="form-row">
              <label for="preco">Preço (R$)</label>
              <input id="preco" type="number" step="0.01" min="0" placeholder="Ex.: 299,90" required />
            </div>

            <div class="form-row">
              <label for="numeracao">Numeração disponível</label>
              <input id="numeracao" type="text" placeholder="Ex.: 37, 38, 39, 40, 41, 42" required />
            </div>

            <div class="form-row">
              <label for="status">Status</label>
              <select id="status">
                <option value="ativo">Ativo</option>
                <option value="inativo">Inativo / Oculto</option>
                <option value="pouco-estoque">Pouco estoque</option>
              </select>
            </div>

            <div class="form-row">
              <label for="imagem">URL da imagem (opcional)</label>
              <input id="imagem" type="url" placeholder="Cole o link da foto (se não usar upload)" />
            </div>

            <div class="form-row">
              <label for="imagem-arquivo">Upload de imagem (opcional)</label>
              <input id="imagem-arquivo" type="file" accept="image/*" />
              <small style="font-size:11px; color:#6b7280;">
                Se você enviar um arquivo, ele será usado no lugar da URL acima.
              </small>
            </div>

            <div class="form-row">
              <label for="descricao">Descrição curta</label>
              <textarea id="descricao" rows="3" placeholder="Conforto, material, estilo..."></textarea>
            </div>

            <button type="submit" class="btn-primary">Salvar produto</button>
          </form>
        </article>

        <!-- LISTA DE PRODUTOS -->
        <article class="card" style="min-height: 200px;">
          <h2 class="form-section-title">Produtos cadastrados</h2>
          <p class="page-subtitle" style="margin-bottom: 8px;">
            Estes são os produtos que aparecem na loja.
          </p>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nome</th>
                  <th>Marca</th>
                  <th>Preço</th>
                  <th>Numeração</th>
                  <th>Status</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="produtos-tbody">
                <!-- preenchido via JS -->
              </tbody>
            </table>
          </div>
        </article>
      </section>
    </main>
  </div>

  <!-- JS: conexão com a API -->
  <script>
    const API_URL = "http://127.0.0.1:8000";        // backend FastAPI
    const WHATSAPP_NUMBER = "55SEUNUMEROAQUI";      // mesmo número usado na loja

    const form  = document.getElementById("form-produto");
    const tbody = document.getElementById("produtos-tbody");

    async function carregarProdutos() {
      try {
        const resp = await fetch(`${API_URL}/products`);
        if (!resp.ok) throw new Error("Erro ao carregar produtos");
        const produtos = await resp.json();

        if (!Array.isArray(produtos) || produtos.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" style="font-size:12px; color:#6b7280; text-align:center;">
                Nenhum produto cadastrado ainda. Use o formulário ao lado para adicionar.
              </td>
            </tr>`;
          return;
        }

        tbody.innerHTML = produtos.map((p) => `
          <tr>
            <td>${p.id}</td>
            <td>${p.name}</td>
            <td>${p.brand}</td>
            <td>R$ ${p.price.toFixed(2)}</td>
            <td>${p.sizes}</td>
            <td>${p.status}</td>
            <td>
              <button type="button"
                      class="btn-primary"
                      style="padding:4px 10px; font-size:11px;"
                      onclick="excluirProduto(${p.id})">
                Excluir
              </button>
            </td>
          </tr>
        `).join("");

      } catch (err) {
        console.error(err);
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="font-size:12px; color:#b91c1c;">
              Erro ao carregar produtos. Verifique se a API está rodando em ${API_URL}.
            </td>
          </tr>`;
      }
    }

    async function excluirProduto(id) {
      if (!confirm(`Tem certeza que deseja excluir o produto ID ${id}?`)) return;
      try {
        const resp = await fetch(`${API_URL}/products/${id}`, {
          method: "DELETE",
        });
        if (!resp.ok && resp.status !== 204) {
          alert("Erro ao excluir produto.");
          return;
        }
        await carregarProdutos();
      } catch (err) {
        console.error(err);
        alert("Falha ao conectar com a API.");
      }
    }

    // SUBMIT DO FORMULÁRIO (com upload de imagem)
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      let imageUrl = document.getElementById("imagem").value || null;
      const fileInput = document.getElementById("imagem-arquivo");

      // Se tiver arquivo, faz upload primeiro
      if (fileInput.files.length > 0) {
        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        try {
          const uploadResp = await fetch(`${API_URL}/upload-image`, {
            method: "POST",
            body: formData,
          });
          if (!uploadResp.ok) {
            alert("Erro ao enviar imagem. Use JPG, PNG ou WEBP.");
            return;
          }
          const uploadData = await uploadResp.json();
          imageUrl = uploadData.url;
        } catch (err) {
          console.error(err);
          alert("Falha ao enviar a imagem para o servidor.");
          return;
        }
      }

      const payload = {
        name: document.getElementById("nome").value,
        brand: document.getElementById("marca").value,
        gender: document.getElementById("genero").value,
        category: document.getElementById("categoria").value || null,
        price: parseFloat(document.getElementById("preco").value),
        sizes: document.getElementById("numeracao").value,
        status: document.getElementById("status").value,
        image_url: imageUrl,
        description: document.getElementById("descricao").value || null,
      };

      try {
        const resp = await fetch(`${API_URL}/products`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!resp.ok) {
          alert("Erro ao salvar produto.");
          return;
        }

        const data = await resp.json();
        alert("Produto salvo com sucesso! ID: " + data.id);

        form.reset();
        document.getElementById("genero").value = "Unissex";
        document.getElementById("status").value = "ativo";
        await carregarProdutos();
      } catch (err) {
        console.error(err);
        alert("Falha ao conectar com a API.");
      }
    });

    carregarProdutos();
  </script>
</body>
</html>
